name: Create val to production PR

on:
  # schedule:
  #   - cron: "0 11 * * 2"  # Every Tuesday at 11:00 UTC
  workflow_dispatch:
  # push:
  #   branches:
  #     - bs-auto-prs

permissions:
  contents: write
  pull-requests: write

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version-file: ".nvmrc"
    - name: Generate PR body
      id: pr_body
      run: |
        BODY=$(.github/commit-log.sh val production) || exit_code=$?
        if [ "$exit_code" == "1" ]; then
          echo "No commits. Skipping PR."
          echo "skip=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        echo "$BODY"
        BODY="${BODY//'%'/'%25'}"
        BODY="${BODY//$'\n'/'%0A'}"
        BODY="${BODY//$'\r'/'%0D'}"
        echo "body=$BODY" >> $GITHUB_OUTPUT
        echo "skip=false" >> $GITHUB_OUTPUT
    - name: Create PR
      if: steps.pr_body.outputs.skip != 'true'
      run: |
        gh pr create \
          --base val \
          --head main \
          --title "val â†’ prod" \
          --body "${{ steps.pr_body.outputs.body }}" \
          --draft
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
